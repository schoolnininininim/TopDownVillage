<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Mind Roulette Duo</title>
  <style>
    :root{--bg:#f6fbff;--panel:#ffffff;--accent:#ffd166;--muted:#6f7880}
    html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,monospace}
    .game-wrap{display:flex;flex-direction:column;height:100%;padding:8px;box-sizing:border-box;gap:8px}
    .player-area{display:flex;align-items:center;justify-content:space-between;padding:8px;background:rgba(255,255,255,0.9);border-radius:10px}
    .player-box{display:flex;flex-direction:column;align-items:center;width:48%}
    .meta{font-size:13px;color:var(--muted);display:flex;gap:8px;align-items:center}
    .indicator{background:rgba(0,0,0,0.04);padding:6px 8px;border-radius:8px}
    .controls{display:flex;gap:8px;margin-top:8px;width:100%}
    button.big{flex:1;padding:12px;border-radius:12px;border:0;background:linear-gradient(180deg,#ffd166,#ffc24d);font-weight:800;color:#222;font-size:16px;touch-action:manipulation}
    button.big[disabled]{opacity:0.45}
    .center-canvas{display:flex;align-items:center;justify-content:center}
    canvas{image-rendering:pixelated;background:linear-gradient(180deg,#e9f7ff,#ffffff);border-radius:10px}
    .round-info{display:flex;gap:10px;align-items:center;font-weight:700;color:#333}
    .active{outline:3px solid rgba(255,209,102,0.25);box-shadow:0 6px 0 rgba(0,0,0,0.06)}
    @media(max-width:420px){button.big{padding:14px;font-size:18px}}
  </style>
</head>
<body>
  <div class="game-wrap">
    <!-- Top player (Player 1) -->
    <div class="player-area" id="player1Area">
      <div class="player-box" style="align-items:flex-end">
        <div style="width:64px;height:64px"></div>
        <div class="meta"><strong>Player 1</strong><div class="indicator">Penalty: <span id="p1Score">0</span></div></div>
      </div>
      <div style="width:48%;display:flex;flex-direction:column;align-items:flex-start">
        <div class="round-info">Round <span id="roundNum">1</span> / 10 · Bullets left: <span id="bulletsLeft">-</span></div>
        <div class="controls">
          <button id="p1Self" class="big">Self-shot</button>
          <button id="p1Opp" class="big">Opponent-shot</button>
        </div>
      </div>
    </div>

    <!-- Center canvas -->
    <div class="center-canvas">
      <canvas id="gameCanvas" width="320" height="220"></canvas>
    </div>

    <!-- Bottom player (Player 2) -->
    <div class="player-area" id="player2Area">
      <div style="width:48%;display:flex;flex-direction:column;align-items:flex-end">
        <div class="controls">
          <button id="p2Self" class="big">Self-shot</button>
          <button id="p2Opp" class="big">Opponent-shot</button>
        </div>
      </div>
      <div class="player-box" style="align-items:flex-start">
        <div style="width:64px;height:64px"></div>
        <div class="meta"><strong>Player 2</strong><div class="indicator">Penalty: <span id="p2Score">0</span></div></div>
      </div>
    </div>
  </div>

  <script>
    // Mind Roulette Duo - Two players on one mobile device
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;

    // UI elements
    const p1Self = document.getElementById('p1Self');
    const p1Opp = document.getElementById('p1Opp');
    const p2Self = document.getElementById('p2Self');
    const p2Opp = document.getElementById('p2Opp');
    const p1ScoreEl = document.getElementById('p1Score');
    const p2ScoreEl = document.getElementById('p2Score');
    const bulletsLeftEl = document.getElementById('bulletsLeft');
    const roundNumEl = document.getElementById('roundNum');
    const p1Area = document.getElementById('player1Area');
    const p2Area = document.getElementById('player2Area');

    // Game state
    let round = 1;
    const TOTAL_ROUNDS = 10;
    let chambers = new Array(10).fill(0); // 10 chambers
    let currentIndex = 0; // next chamber index
    let bulletsRemaining = 0; // number of real bullets placed
    let p1Penalty = 0; let p2Penalty = 0;
    let currentPlayer = Math.random() < 0.5 ? 1 : 2; // who starts
    let animating = false;

    function startRound(){
      // Randomly load 1..3 bullets into 10 chambers
      chambers = new Array(10).fill(0);
      const load = Math.floor(Math.random()*3)+1;
      bulletsRemaining = load;
      let placed = 0;
      while(placed < load){
        const i = Math.floor(Math.random()*10);
        if(chambers[i] === 0){ chambers[i] = 1; placed++; }
      }
      currentIndex = 0;
      bulletsLeftEl.textContent = bulletsRemaining;
      roundNumEl.textContent = round;
      highlightActive();
      drawScene();
    }

    function nextRound(){
      round++;
      if(round > TOTAL_ROUNDS){ finishGame(); return; }
      startRound();
    }

    function finishGame(){
      let result = '무승부';
      if(p1Penalty < p2Penalty) result = 'Player 1 승리';
      else if(p2Penalty < p1Penalty) result = 'Player 2 승리';
      setTimeout(()=>{
        if(confirm(`게임 종료\nPlayer1 penalty: ${p1Penalty}\nPlayer2 penalty: ${p2Penalty}\n${result}\n\n다시 플레이?`)){
          // reset
          p1Penalty = 0; p2Penalty = 0; round = 1; p1ScoreEl.textContent = p1Penalty; p2ScoreEl.textContent = p2Penalty;
          startRound();
        }
      },200);
    }

    function highlightActive(){
      if(currentPlayer===1){ p1Area.classList.add('active'); p2Area.classList.remove('active'); }
      else { p2Area.classList.add('active'); p1Area.classList.remove('active'); }
      // enable only active player's buttons
      p1Self.disabled = p1Opp.disabled = p2Self.disabled = p2Opp.disabled = true;
      if(currentPlayer === 1){ p1Self.disabled = false; p1Opp.disabled = false; }
      else { p2Self.disabled = false; p2Opp.disabled = false; }
    }

    function handleAction(player, choice){
      if(animating) return; if(player !== currentPlayer) return;
      animating = true;
      const hasBullet = !!chambers[currentIndex];
      const target = (choice==='self') ? player : (player===1?2:1);

      animateShot(player, target, hasBullet).then(()=>{
        if(hasBullet){
          chambers[currentIndex] = 0; bulletsRemaining--; bulletsLeftEl.textContent = bulletsRemaining;
          // apply penalty to the entity that got hit
          if(target===1){ p1Penalty++; p1ScoreEl.textContent = p1Penalty; }
          else { p2Penalty++; p2ScoreEl.textContent = p2Penalty; }
          // turn passes to opponent
          currentPlayer = (player===1?2:1);
        } else {
          if(choice==='self'){
            // empty self-shot -> keep turn
            currentPlayer = player;
          } else {
            // empty opponent-shot -> turn passes
            currentPlayer = (player===1?2:1);
          }
        }
        currentIndex = (currentIndex + 1) % 10;
        if(bulletsRemaining <= 0){ animating = false; setTimeout(nextRound, 600); }
        else { animating = false; highlightActive(); drawScene(); }
      });
    }

    // Attach handlers
    p1Self.addEventListener('click', ()=>handleAction(1,'self'));
    p1Opp.addEventListener('click', ()=>handleAction(1,'opp'));
    p2Self.addEventListener('click', ()=>handleAction(2,'self'));
    p2Opp.addEventListener('click', ()=>handleAction(2,'opp'));

    // Simple pixel art drawing & animation
    function drawScene(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // bright, clean background
      ctx.fillStyle = '#f0fbff'; ctx.fillRect(0,0,canvas.width,canvas.height);
      // top player
      drawPixelSprite(40,18,'#ffd1c1','#b24');
      // bottom player
      drawPixelSprite(40,130,'#bfe6ff','#146');
      // gun in center
      drawGun(120,70);
    }

    function drawPixelSprite(x,y,color,accent){
      const s = 4; const pixels = ['..xx..','.xxxx.','xxxxxx','.xx.xx','..xx..','.x..x.'];
      for(let r=0;r<pixels.length;r++){
        for(let c=0;c<pixels[r].length;c++){
          if(pixels[r][c]==='x'){ ctx.fillStyle = color; ctx.fillRect(x+c*s,y+r*s,s,s); }
        }
      }
    }

    function drawGun(x,y){ ctx.fillStyle='#333'; ctx.fillRect(x,y,80,14); ctx.fillStyle='#222'; ctx.fillRect(x+72,y+3,14,8); }

    function animateShot(shooter, target, isBullet){
      return new Promise((resolve)=>{
        const from = {x: 160, y: 82};
        const to = (target===1)? {x:80,y:36} : {x:80,y:166};
        const dur = isBullet? 380 : 200;
        let start=null;
        function frame(ts){ if(!start) start=ts; const t=Math.min(1,(ts-start)/dur); drawScene(); if(t<0.15){ ctx.fillStyle='rgba(255,220,150,'+(1-t*6)+')'; ctx.fillRect(from.x+28,from.y-6,12,20); }
          const bx = from.x + (to.x-from.x)*t; const by = from.y + (to.y-from.y)*t;
          if(isBullet){ ctx.fillStyle='#222'; ctx.beginPath(); ctx.arc(bx,by,4,0,Math.PI*2); ctx.fill(); }
          if(t<1) requestAnimationFrame(frame); else requestAnimationFrame(()=>resolve()); }
        requestAnimationFrame(frame);
      });
    }

    // start
    p1ScoreEl.textContent = p1Penalty; p2ScoreEl.textContent = p2Penalty;
    startRound(); highlightActive(); drawScene();
  </script>
</body>
</html>
